import React from 'react';
import { BrowserRouter as Router, Route, Switch, Redirect, withRouter } from 'react-router-dom';
import { connect } from 'react-redux';
import { PrivateRoute } from './PrivateRoute';
import { PublicRoute } from './PublicRoute';
import {
    MainPage,
    Login,
    Register,
    Menu,
    NoMatch,
    AllChats,
    ChatWrapper,
    Chat,
    Messages
} from 'components';
import { isSuccess, isFailure, changeChatLastMessage } from 'actions';
import localStorageApi from 'services/localStorageApi';
import {LOGIN} from 'constants/user';
import {API_URL} from "constants/server";
import {TEXT_MESSAGE} from "constants/websocket-actions-types";

/*eslint-disable */ 
class Routes extends React.Component {
    constructor(props) {
        super(props)
        this.state = {
            ready: false
        }
    }

    componentWilMount() {
        let fucked_you_async = false;
        const auth_credits = [
            {'username': 'denis4', 'password': 'q'},
            {'username': 'nikita3', 'password': 'q'},
            {'username': 'artem5', 'password': 'q'}];
        const auth = auth_credits[Math.floor(Math.random() * 3)];
        axios.post(`${API_URL}/obtain-jwt-token/`,
            {
                'username': auth['username'],
                'password': auth['password']
            })
            .then(response => {
                localStorage.setItem('token', response.data['token']);
                return response.data['token']
            })
            .then((token) => {
                const config = {
                    headers: {'Authorization': 'JWT ' + token}
                };
                axios.get(`${API_URL}/self-users/?fields=id`, config)
                    .then(response => {
                        localStorage.setItem('user_id', response.data['id']);
                        this.setState({'ready': true})

                    });
                const user_socket = new WebSocket('ws://0.0.0.0:8000/user/?token=' + token);
                user_socket.onopen = () => {
                    console.log("User chat_socket open");
                };
                user_socket.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    if (data.type === TEXT_MESSAGE) {
                        console.log(data.action);
                        console.log('dispatch comp')
                        this.props.changeChatLastMessage(data.action)
                    }

                };
                user_socket.onclose = () => {
                    console.log('User chat_socket disconnected')
                };
                user_socket.onerror = (e) => {
                    console.log(e)
                };
            });
    }

    componentDidMount() {
        this.props.setLoggedIn(localStorageApi.getItem());
    }

    render() {
        console.log(this)
        return(
            <Router>
                <Switch>
                    <PrivateRoute exact path="/" component={MainPage}/>
                    <Route
                        path="/logout"
                        render={() => {
                            localStorage.removeItem('token');
                            return <Redirect to="login"/>;
                        }}
                    />
                    <PublicRoute path="/login" component={Login} />
                    <PublicRoute path="/register" component={Register} />
                    <Route path='/chat' component={Chat}/>
                    <PrivateRoute path='/messages' component={Messages}/>
                    <Route path='/chat-test' component={AllChats}/>
                    <Route path='/chat-wrapper' component={ChatWrapper}/>
                    <Route exact path="*" render={() => <NoMatch isLoggedIn={this.props.isLoggedIn}/>} />
                </Switch>
            </Router>
       )
    }
        
}

const mapStateToProps = state => ({
    isLoggedIn: state.login.isLoggedIn
});

const mapDispatchToProps = dispatch => (
        {
            setLoggedIn: state => state ? dispatch(isSuccess(LOGIN)) : dispatch(isFailure(LOGIN)),
            changeChatLastMessage: (last_message) => (dispatch(changeChatLastMessage(last_message))),
        }
    );

export default connect(mapStateToProps, mapDispatchToProps)(Routes);
