import React, { Fragment } from 'react';
import { connect } from 'react-redux';
import { withRouter } from 'react-router-dom';
import { SubmissionError } from 'redux-form';

import { isFailure, isLoading, isSuccess } from 'actions';

import { LOGIN } from 'constants/index'

import { postPattern } from 'services/sendAccount';
import localStorageApi from 'services/localStorageApi';

//Components
import Form from './Form';

class Login extends React.Component {
    constructor() {
        super();
        this.LOGIN = LOGIN;
        this.formSubmit = this.formSubmit.bind(this);
    }
    formSubmit(values) {
        const { LOGIN } = this;
        this.props.isLoading(LOGIN);
        return postPattern('/api/obtain-jwt-token/', values)
            .then(
                json => {
                    const { token } = json.data;
                    localStorageApi.setItem('token', token);
                    this.props.isSuccess(LOGIN, {token});
                    this.props.subscribeNotifies(token);
                    this.props.loadUserInfo(token);
                    this.props.history.push('/');
                },
                err => {
                    this.props.isFailure(LOGIN);
                }
            );
    };

    render() {
        return (
            <Fragment>
                <Form formSubmit={this.formSubmit} />
            </Fragment>
        );
    }
}

export default withRouter(connect(null, {isFailure, isLoading, isSuccess})(Login));
